{% extends 'solverrapp/base.html' %}

{% block content%}
<h3>Add a new Question</h3>
<form>
    <div class="mb-3">
        <label class="form-label">Question Type</label>
        <select class="form-select mb-1" id="question-type-select" aria-label="Question Type Select"
            onchange="update_question_type()">
            {% for key, value in question_types %}
            <option value="{{key}}">{{ value }}</option>
            {% endfor %}
        </select>
        <small class="text-secondary">
            • Single Correct: Only one option can be correct out of the given options<br>
            • Multiple Correct: Multiple options can be correct at the same time<br>
            • Integer Type: The answer can include numbers from 0-9. No fractions or rational numbers<br>
            • Numerical Type: The answer can include any number including decimals and negative numbers<br>
        </small>
    </div>
    <h5 class="mb-2">Question Body</h5>
    <div class="row g-3 mb-3">
        <div class="col-md-7">
            <div class="btn-toolbar mb-1" role="toolbar">
                <div class="btn-group me-2" role="group" aria-label="Image">
                    <button type="button" class="btn btn-outline-secondary" title="Insert Image"
                        onclick="insertImageCode()" style="border-radius: 0;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                            class="bi bi-image" viewBox="0 0 16 16">
                            <path d="M6.002 5.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0" />
                            <path
                                d="M2.002 1a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2zm12 1a1 1 0 0 1 1 1v6.5l-3.777-1.947a.5.5 0 0 0-.577.093l-3.71 3.71-2.66-1.772a.5.5 0 0 0-.63.062L1.002 12V3a1 1 0 0 1 1-1z" />
                        </svg>
                    </button>
                </div>

                <div class="btn-group me-2" role="group" aria-label="Equation Insert Toolbar">
                    <button type="button" onclick="insertInlineEquation()" title="Insert Inline Equation"
                        class="btn btn-outline-secondary" style="border-radius: 0;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                            class="bi bi-text-indent-left" viewBox="0 0 16 16">
                            <path
                                d="M2 3.5a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 0 1h-11a.5.5 0 0 1-.5-.5m.646 2.146a.5.5 0 0 1 .708 0l2 2a.5.5 0 0 1 0 .708l-2 2a.5.5 0 0 1-.708-.708L4.293 8 2.646 6.354a.5.5 0 0 1 0-.708M7 6.5a.5.5 0 0 1 .5-.5h6a.5.5 0 0 1 0 1h-6a.5.5 0 0 1-.5-.5m0 3a.5.5 0 0 1 .5-.5h6a.5.5 0 0 1 0 1h-6a.5.5 0 0 1-.5-.5m-5 3a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 0 1h-11a.5.5 0 0 1-.5-.5" />
                        </svg>
                    </button>
                    <button type="button" title="Insert Block Equation" onclick="insertBlockEquation()"
                        class="btn btn-outline-secondary" style="border-radius: 0;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                            class="bi bi-justify" viewBox="0 0 16 16">
                            <path fill-rule="evenodd"
                                d="M2 12.5a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 0 1h-11a.5.5 0 0 1-.5-.5m0-3a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 0 1h-11a.5.5 0 0 1-.5-.5m0-3a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 0 1h-11a.5.5 0 0 1-.5-.5m0-3a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 0 1h-11a.5.5 0 0 1-.5-.5" />
                        </svg>
                    </button>
                </div>

                <div class="btn-group me-2" role="group" aria-label="Equations Toolbar">
                    <button type="button" onclick="insertoperator('sqrt')" title="Insert Square Root"
                        class="btn btn-outline-secondary" style="border-radius: 0;">
                        $\sqrt{x}$
                    </button>
                    <button type="button" title="Insert Superscript" onclick="insertoperator('super')"
                        class="btn btn-outline-secondary" style="border-radius: 0;">
                        $a^x$
                    </button>
                    <button type="button" title="Insert Subscript" onclick="insertoperator('sub')"
                        class="btn btn-outline-secondary" style="border-radius: 0;">
                        $a_x$
                    </button>
                    <button type="button" title="Insert Not Equals" onclick="insertoperator('neq')"
                        class="btn btn-outline-secondary" style="border-radius: 0;">
                        $\neq$
                    </button>
                    <button type="button" title="Insert Multiplication Operator" onclick="insertoperator('times')"
                        class="btn btn-outline-secondary" style="border-radius: 0;">
                        $\times$
                    </button>
                    <button type="button" title="Insert Division Operator" onclick="insertoperator('div')"
                        class="btn btn-outline-secondary" style="border-radius: 0;">
                        $\div$
                    </button>
                </div>
            </div>
            <textarea rows="5" type="text" oninput="renderQuestion()" class="form-control" style="border-radius: 0;"
                id="question_body" required>
                If 23 ohms of resistance is added to 12 oscillation terminator at the ends of a broken wire such that a $\times$ b is working properly.
            </textarea>
        </div>
        <div class="col-md-5">
            <label class="form-label mb-4">Preview Question</label>
            <div id="question-preview" class="p-3" style="border: rgb(208, 208, 208) 1px solid;"></div>
        </div>
    </div>

    <h5>Answer</h5>
    <div class="mb-3" id="options-container">
        <label class="mb-2">Edit Options</label>
        <div class="option">
            <ul>
                <li class="option-item">
                    <div class="input-group">
                        <input type="text" class="form-control option-value" aria-label="option-value"
                            aria-describedby="remove-option1">
                        <button class="btn btn-outline-danger remove-option" type="button">Remove</button>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input correct-answer">
                        <label class="form-check-label">Correct Answer</label>
                    </div>
                </li>
                <li class="option-item">
                    <div class="input-group">
                        <input type="text" class="form-control option-value" aria-label="option-value"
                            aria-describedby="remove-option2">
                        <button class="btn btn-outline-danger remove-option" type="button">Remove</button>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input correct-answer">
                        <label class="form-check-label">Correct Answer</label>
                    </div>
                </li>
            </ul>
            <button type="button" class="btn btn-outline-secondary add-option">Add an Option</button>
        </div>
    </div>

    <div class="mb-3" id="answer-container">
        <input id="answer-input" type="text" placeholder="Enter Answer" class="form-control">
    </div>

    <div class="mb-3" id="metadata-section">
        <h5>Metadata</h5>
        <label class="form-label">Sources</label>
        <input class="form-control mb-3" placeholder="Search Sources" type="text">
        <select class="form-select mb-1" size="5" aria-label="source select" multiple>
            {%for source in sources%}
            <option class="source-option" value="{{source.name}}">{{source.name}}</option>
            {% endfor %}
        </select>
        <small class="text-secondary">
            Multiple sources can be selected at once. Hold down control for windows or command for mac and click on the
            sources you want to select
        </small>
    </div>

    <button type="button" onclick="SubmitQuestion()" class="btn btn-primary">Submit</button>
</form>

<!-- TOAST -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="liveToast" class="toast text-bg-danger" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                class="bi bi-exclamation-circle-fill" viewBox="0 0 16 16">
                <path
                    d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0M8 4a.905.905 0 0 0-.9.995l.35 3.507a.552.552 0 0 0 1.1 0l.35-3.507A.905.905 0 0 0 8 4m.002 6a1 1 0 1 0 0 2 1 1 0 0 0 0-2" />
            </svg>
            <strong class="ms-1 me-auto">Solverr</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body">
        </div>
    </div>
</div>
<!--  -->


<script>
    function renderQuestion() {
        var text = document.getElementById('question_body').value;
        const imgMdPattern = /!\[(.*?)\]\((.*?)\)/g;

        var newText = text.replace(imgMdPattern, (match, altText, src) => {
            return `<img src="${src}" style="max-height:250px;" alt="${altText}">`;
        });
        var newText = newText.replace(/\n/g, "<br>");

        preview_p = document.getElementById('question-preview');
        preview_p.innerHTML = newText;

        renderMathInElement(
            preview_p,
            {
                delimiters: [
                    { left: "$$", right: "$$", display: true },
                    { left: "$", right: "$", display: false },
                ]
            }
        );
    }
</script>

<script>
    const addOptionButton = document.querySelector('.add-option');
    const optionsContainer = document.getElementById('options-container');
    const questionTypeSelect = document.getElementById('question-type-select');
    const questionanswerdiv = document.getElementById('answer-container');

    // Text Area Start
    const questionBodyTextarea = document.getElementById('question_body');
    function insertImageCode() {
        text = questionBodyTextarea.value;

        questionBodyTextarea.value = text + "![Image Description](URL)";
        questionBodyTextarea.focus();

        // Set cursor position between parentheses
        const endPos = questionBodyTextarea.selectionEnd;
        questionBodyTextarea.setSelectionRange(endPos - 4, endPos - 1);
    }
    function insertInlineEquation() {
        text = questionBodyTextarea.value;

        questionBodyTextarea.value = text + "$LATEX EQUATION$";
        questionBodyTextarea.focus();
        const endPos = questionBodyTextarea.selectionEnd;
        questionBodyTextarea.setSelectionRange(endPos - 15, endPos - 1);
    }

    function insertBlockEquation() {
        text = questionBodyTextarea.value;

        questionBodyTextarea.value = text + "$$LATEX EQUATION$$";
        questionBodyTextarea.focus();
        const endPos = questionBodyTextarea.selectionEnd;
        questionBodyTextarea.setSelectionRange(endPos - 16, endPos - 2);
    }

    function insertoperator(operator) {
        var text = questionBodyTextarea.value;
        var cursorPosition = questionBodyTextarea.selectionStart;
        var pretext = text.slice(0, cursorPosition);
        var aftertext = text.slice(cursorPosition);

        // Check if in an equation
        // Check for block
        var count = (pretext.match(/\$$/g) || []).length;
        var isEven = count % 2 === 0;

        // Check for inline
        if (isEven == true) {
            count = (pretext.match(/\$/g) || []).length;
            isEven = count % 2 === 0;
        }

        // isEven -> False: Currently in equation
        // isEven -> True: Not in equation

        // SQUARE ROOT
        if (operator == 'sqrt') {
            if (isEven) {
                var newtext = pretext + "$\\sqrt{x}$" + aftertext;
                questionBodyTextarea.value = newtext;
                questionBodyTextarea.focus();
                questionBodyTextarea.setSelectionRange(pretext.length + 7, pretext.length + 8);
            } else {
                var newtext = pretext + "\\sqrt{x}" + aftertext;
                questionBodyTextarea.value = newtext;
                questionBodyTextarea.focus();
                questionBodyTextarea.setSelectionRange(pretext.length + 6, pretext.length + 7);
            }
        }

        // SUPERSCRIPT
        if (operator == 'super') {
            var newtext = pretext + "^{x}" + aftertext;
            questionBodyTextarea.value = newtext;
            questionBodyTextarea.focus();
            questionBodyTextarea.setSelectionRange(pretext.length + 2, pretext.length + 3);
        }

        // SUBSCRIPT
        if (operator == 'sub') {
            var newtext = pretext + "_{x}" + aftertext;
            questionBodyTextarea.value = newtext;
            questionBodyTextarea.focus();
            questionBodyTextarea.setSelectionRange(pretext.length + 2, pretext.length + 3);
        }

        // Other symbols
        if (operator == 'neq' || operator == 'times' || operator == 'div') {
            if (isEven) {
                var newtext = pretext + "$\\" + operator + "$" + aftertext;
                questionBodyTextarea.value = newtext;
                cur_pos = pretext.length + 3 + operator.length
            } else {
                var newtext = pretext + "\\" + operator + aftertext;
                questionBodyTextarea.value = newtext;
                cur_pos = pretext.length + 1 + operator.length
            }
            questionBodyTextarea.focus();
            questionBodyTextarea.setSelectionRange(cur_pos, cur_pos);
        }

    }
    // Text Area End

    function addOption() {
        const optionItem = optionsContainer.querySelector('.option-item');
        const newOptionItem = optionItem.cloneNode(true);
        optionsContainer.querySelector('ul').appendChild(newOptionItem);
    }

    function resetCheckboxes() {
        const checkboxes = optionsContainer.querySelectorAll('.form-check-input');
        checkboxes.forEach((checkbox) => {
            checkbox.checked = false;
        });
    }

    function handleSingleCorrectSelection(event) {
        const checkboxes = optionsContainer.querySelectorAll('.form-check-input');
        checkboxes.forEach((checkbox) => {
            if (checkbox !== event.target && checkbox.checked) {
                checkbox.checked = false;
            }
        });
    }

    function update_question_type() {
        var question_type = document.getElementById('question-type-select').value;
        console.log(question_type);
        var options_container = document.getElementById('options-container');

        // Hide/Show options block
        if (question_type == 'SCQ' || question_type == 'MCQ') {

            options_container.style.display = 'block';
        } else {
            options_container.style.display = 'None';
        }

        // Reset checkboxes and Make options single correct
        if (questionTypeSelect.value === 'SCQ') {
            resetCheckboxes();
            const checkboxes = optionsContainer.querySelectorAll('.form-check-input');
            checkboxes.forEach((checkbox) => {
                checkbox.addEventListener('change', handleSingleCorrectSelection);
            });
        }

        // For MCQ
        if (questionTypeSelect.value === 'MCQ') {
            const checkboxes = optionsContainer.querySelectorAll('.form-check-input');
            checkboxes.forEach((checkbox) => {
                checkbox.removeEventListener('change', handleSingleCorrectSelection);
            });
        }

        // Numerical or INT or fill in
        if (questionTypeSelect.value == 'NUM' || questionTypeSelect.value == 'INT' || questionTypeSelect.value == 'FILL' || questionTypeSelect.value == 'LONG') {
            questionanswerdiv.style.display = 'block';
        } else {
            questionanswerdiv.style.display = 'None';
        }

        // FOR SUBJECTIVE/LONG
        if (questionTypeSelect.value == 'LONG') {
            var inputElement = document.getElementById("answer-input");
            var textAreaElement = document.createElement("textarea");
            textAreaElement.value = inputElement.value;
            textAreaElement.id = inputElement.id;
            textAreaElement.name = inputElement.name;
            textAreaElement.className = inputElement.className;
            textAreaElement.placeholder = inputElement.placeholder;

            textAreaElement.rows = "4"; // Set number of rows                
            inputElement.parentNode.replaceChild(textAreaElement, inputElement);
        } else {
            var inputElement = document.getElementById("answer-input");
            var textAreaElement = document.createElement("input");
            textAreaElement.value = inputElement.value;
            textAreaElement.id = inputElement.id;
            textAreaElement.name = inputElement.name;
            textAreaElement.className = inputElement.className;
            textAreaElement.placeholder = inputElement.placeholder;
            inputElement.parentNode.replaceChild(textAreaElement, inputElement);
        }

    }

    document.addEventListener("DOMContentLoaded", function () {
        // Ensure there are at least two options on load
        if (optionsContainer.querySelectorAll('.option-item').length < 2) {
            addOption();
        }

        addOptionButton.addEventListener('click', function () {
            addOption();
            resetCheckboxes();
        });

        optionsContainer.addEventListener('click', function (event) {
            if (event.target && event.target.classList.contains('remove-option')) {
                const optionItem = event.target.closest('.option-item');
                if (optionsContainer.querySelectorAll('.option-item').length > 2) {
                    optionItem.remove();
                } else {
                    alert('At least two options are needed for a multiple choice question.');
                }
            }
        });

        update_question_type();

    });
</script>

<script>
    function isEmpty(str) {
        return !str.trim().length;
    }
    function toastError(message) {
        const toastLiveExample = document.getElementById('liveToast')
        const toastBootstrap = bootstrap.Toast.getOrCreateInstance(toastLiveExample);
        const toastBody = document.querySelector('.toast-body');
        toastBody.innerHTML = message;
        toastBootstrap.show()
    }

    function SubmitQuestion() {
        var question_type = document.getElementById('question-type-select').value;
        var question_body = document.getElementById('question_body').value;
        var _options = [];


        if (isEmpty(question_body)) {
            toastError("You cannot leave the question blank.");
            return;
        }

        a = question_type == 'SCQ';
        b = question_type == 'MCQ';
        if (a || b) {
            var optionsContainer = document.getElementById('options-container');
            var optionItems = optionsContainer.querySelectorAll('.option-item');

            for (i = 0; i < optionItems.length; i++) {
                var index = i;
                console.log(index);
                var item = optionItems[index];
                var optionValue = item.querySelector('.option-value').value;


                if (isEmpty(optionValue)) {
                    toastError("You cannot leave the option blank.");
                    return;
                }

                var isCorrect = item.querySelector('.correct-answer').checked;
                _options[index] = ({
                    option_index: index + 1,
                    option_body: optionValue,
                    is_correct: isCorrect
                });
            }
            var one_correct = false;
            _options.forEach(item => {
                if (item.is_correct) {
                    one_correct = true;
                }
            });

            if (one_correct == false) {
                toastError('No option was marked as correct.');
                return 0;
            }
        }

        if (question_type == 'INT' || question_type == 'NUM' || question_type == 'LONG' || question_type == 'FILL') {
            var question_answer = document.getElementById('answer-input').value;
            console.log(question_answer);
            if (isEmpty(question_answer)) {
                toastError("The answer cannot be blank.");
                return;
            }

            // CASE: INTEGER TYPE
            if (question_type == 'INT') {
                const int_regex = /^[0-9]$/;
                if (int_regex.test(question_answer) == false) {
                    toastError("Integer type questions can only have answer from 0-9 excluding negative integers and decimals.");
                    return;
                }
            }

            // CASE: NUMERICAL TYPE
            if (question_type == 'NUM') {
                const num_regex = /^-?\d*\.?\d+$/;
                if (num_regex.test(question_answer) == false) {
                    toastError("Numerical type questions can only have numerical answers. No other characters allowed.");
                    return;
                }
            }
        }

        var question = {
            type: question_type,
            body: question_body,
            options: _options,
            answer: question_answer,
        }

        fetch('/api/new/question', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(question)
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json(); // Parse the JSON response
            })
            .then(data => {
                console.log('POST request succeeded with JSON response', data);
                new_q_id = data.index;
                window.location.replace("/questions/"+new_q_id);
            })
            .catch(error => {
                console.error('There was a problem with the POST request:', error);
            });
    }
</script>
{% endblock %}